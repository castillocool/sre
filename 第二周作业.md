#                     第二周作业

1. 基于dockerfile，实现分层构建的nginx业务镜像
2. 基于docker实现对容器的CPU和内存的资源限制
3. 部署http协议的harbor镜像仓库
4. 基于docker-compose实现对nginx+tomcat web服务的单机编排
5. 扩展作业：

​       5.1 掌握containerd的安装

​       5.2 基于nerdctl拉取镜像和创建容器 

## 基于dockerfile，实现分层构建的nginx业务镜像

```bash
#清除历史容器
root@castillo:~# docker stop `docker ps | awk '{if (NR>1){print $1}}'`
root@castillo:~# docker rm `docker ps -a | awk '{if (NR>1){print $1}}'`
```

### 编写二进制安装nginx_dockerfile

```dockerfile
FROM ubuntu:22.04
MAINTAINER "jinliucastillo"

ADD sources.list /etc/apt/sources.list

RUN apt update && apt install -y iproute2 ntpdate tcpdump telnet traceroute nfs-kernel-server nfs-common lrzsz tree openssl libssl-dev libpcre3 libpcre3-dev zlib1g-dev ntpdate tcpdump telnet traceroute gcc openssh-server lrzsz tree openssl libssl-dev libpcre3 libpcre3-dev zlib1g-dev ntpdate tcpdump telnet traceroute iotop unzip zip make

ADD nginx-1.22.1.tar.gz /usr/local/src/
RUN cd /usr/local/src/nginx-1.22.1 && ./configure --prefix=/apps/nginx && make && make install && ln -sv /apps/nginx/sbin/nginx /usr/bin
RUN groupadd -g 2088 nginx && useradd -g nginx -s /usr/sbin/nologin -u 2088 nginx && chown -R nginx.nginx /apps/nginx
ADD nginx.conf /apps/nginx/conf/
ADD frontend.tar.gz /apps/nginx/html/

EXPOSE 80 443
CMD ["nginx","-g","daemon off;"]
```

### 构建nginx镜像

```bash
root@castillo:/opt/cicd# docker build -t harbor.jinliu.net/myserver/nginx:v1 .
root@castillo:/opt/cicd# docker images
REPOSITORY                         TAG       IMAGE ID       CREATED              SIZE
harbor.jinliu.net/myserver/nginx   v1        5f227fbc596b   About a minute ago   470MB
ubuntu                             22.04     9d28ccdc1fc7   11 months ago        76.3MB
root@castillo:/opt/cicd# docker run -dit -p 80:80 harbor.jinliu.net/myserver/nginx:v1
```

### 提交镜像

```bash
root@castillo:/opt/cicd# docker commit -m "nginx image v2" -a "jinliu castillo" -c "EXPOSE 80 443" 2330728e0b6e harbor.jinliu.net/myserver/nginx:v2
sha256:e6954854a75e849fc0cb4164da30f2b5dc52d8ac58344e76014eacaf7de2ef3f
root@castillo:/opt/cicd# docker images
REPOSITORY                         TAG       IMAGE ID       CREATED          SIZE
harbor.jinliu.net/myserver/nginx   v2        e6954854a75e   6 seconds ago    514MB
harbor.jinliu.net/myserver/nginx   v1        5f227fbc596b   21 minutes ago   470MB
ubuntu                             22.04     9d28ccdc1fc7   11 months ago    76.3MB
root@castillo:/opt/cicd#
```

## 基于docker实现对容器的CPU和内存的资源限制

### 理解

![1](../002/1.png)

```bash
#查看内核支持情况
[root@k8s-c-jl-01 ~]# docker info
Client:
 Context:    default
 Debug Mode: false
 Plugins:
  app: Docker App (Docker Inc., v0.9.1-beta3)
  buildx: Docker Buildx (Docker Inc., v0.9.1-docker)
  scan: Docker Scan (Docker Inc., v0.21.0)

Server:
 Containers: 0
  Running: 0
  Paused: 0
  Stopped: 0
 Images: 0
 Server Version: 20.10.21
 Storage Driver: overlay2
  Backing Filesystem: xfs
  Supports d_type: true
  Native Overlay Diff: true
  userxattr: false
 Logging Driver: json-file
 Cgroup Driver: systemd
 Cgroup Version: 1
 Plugins:
  Volume: local
  Network: bridge host ipvlan macvlan null overlay
  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog
 Swarm: inactive
 Runtimes: io.containerd.runtime.v1.linux runc io.containerd.runc.v2
 Default Runtime: runc
 Init Binary: docker-init
 containerd version: 1c90a442489720eec95342e1789ee8a5e1b9536f
 runc version: v1.1.4-0-g5fd4c4d
 init version: de40ad0
 Security Options:
  seccomp
   Profile: default
 Kernel Version: 3.10.0-957.el7.x86_64
 Operating System: CentOS Linux 7 (Core)
 OSType: linux
 Architecture: x86_64
 CPUs: 2
 Total Memory: 7.795GiB
 Name: k8s-c-jl-01
 ID: NA77:3K7L:FKMS:5JW5:6KMC:LOZI:RQ6G:EZMM:ZZFI:BEJL:PGCG:RVDG
 Docker Root Dir: /var/lib/docker
 Debug Mode: false
 Registry: https://index.docker.io/v1/
 Labels:
 Experimental: false
 Insecure Registries:
  192.168.31.113
  harbor.jinliu.net
  127.0.0.0/8
 Registry Mirrors:
  https://r1yv1i78.mirror.aliyuncs.com/
 Live Restore Enabled: false

[root@k8s-c-jl-01 ~]# 
```

### 触发条件

- oom的触发条件是：系统无法给应用程序分配物理内存。
- 无法分配到物理内存并不意味着物理内存已耗尽，也可能是其它缘由，如下：

​     ------内存划分过小，剩余内存都是内存碎片，无法分配一个稍大的内存。

```bash
#物理内存阈值设置
[root@k8s-c-jl-01 ~]# cat /proc/sys/vm/min_free_kbytes
67584
[root@k8s-c-jl-01 ~]#

#该阈值是Linux最低剩余多少空闲物理内存（Kbytes）给内核使用；当可用物理内存低于这个参数时，系统触发缓存回收机制，以释放内存，直到可用物理内存大于这个值。该值不能设置的过小，原因如下：
--当该值设置的过小，并且内存资源使用过量时，没有及时kill进程释放内存资源，如果设置了swap，当物理内存过低，降低内存页的命中率，也会导致内存频繁换页，频繁将内存页写入swap分区（磁盘），导致系统运行卡顿。设置过小也可能会出现驱动加载时分配内存失败，无法加载驱动。测试发现：过小会增加系统死机的概率，当内存太少，内核容易出现内存不足以处理异常事件，导致直接死机，无任何反应，例如：串口无任何输出。
#该值也不能设置过大，原因如下：
--设置过大，会导致应用层能使用的物理内存减少，导致程序被kill掉。
```

### oom和内存缓存

为尽量避免oom，需应用设计合适逻辑进行内存释放或刷盘。或加入类似redis中间件

### oom优先级机制

![2](../002/2.png)

![3](../002/3.png)

### 测试内存限制

```bash
root@castillo:/opt/cicd# docker run -it --rm --name jinliu-c1 lorel/docker-stress-ng --vm 2 --vm-bytes 256M
stress-ng: info: [1] defaulting to a 86400 second run per stressor
stress-ng: info: [1] dispatching hogs: 2 vm

root@castillo:~# docker stats
CONTAINER ID   NAME             CPU %     MEM USAGE / LIMIT     MEM %     NET I/O        BLOCK I/O    PIDS
5dd8008128b8   jinliu-c1        198.06%   515.8MiB / 3.832GiB   13.15%    796B / 0B      0B / 0B      5
2330728e0b6e   sleepy_johnson   0.00%     15.47MiB / 3.832GiB   0.39%     11MB / 110kB   0B / 121MB   2

root@castillo:~# docker run -it --rm -m 256m --name jinliu-c2 lorel/docker-stress-ng --vm 2 --vm-bytes 256M
Given value bytes is not a valid decimal for the vm option
root@castillo:~
root@castillo:~# docker run -it --rm -m 256m --name jinliu-c2 lorel/docker-stress-ng --vm 2 --vm-bytes 256M
stress-ng: info: [1] defaulting to a 86400 second run per stressor
stress-ng: info: [1] dispatching hogs: 2 vm


root@castillo:~# docker stats
CONTAINER ID   NAME             CPU %     MEM USAGE / LIMIT     MEM %     NET I/O        BLOCK I/O         PIDS
2330728e0b6e   sleepy_johnson   0.00%     15.47MiB / 3.832GiB   0.39%     11MB / 110kB   0B / 121MB        2
716e0f480798   jinliu-c2        17.54%    255.9MiB / 256MiB     99.95%    656B / 0B      99.5MB / 3.86GB   5
```

### 测试cpu限制

![4](../002/4.png)

```bash
root@castillo:~# docker run -it --rm --name jjinliu-c1 --cpus 2 lorel/docker-stress-ng --cpu 4 --vm 4
stress-ng: info: [1] defaulting to a 86400 second run per stressor
stress-ng: info: [1] dispatching hogs: 4 cpu, 4 vm
^Cstress-ng: info: [1] successful run completed in 91.84s
root@castillo:~# 
```

### 将容器运行到指定CPU 

```bash
root@castillo:~# docker run -it --rm --name jinliu-c1 --cpus 1  --cpuset-cpus 1 lorel/docker-stress-ng --cpu 2 --vm 2
stress-ng: info: [1] defaulting to a 86400 second run per stressor
stress-ng: info: [1] dispatching hogs: 2 cpu, 2 vm

root@castillo:~# docker stats
CONTAINER ID   NAME             CPU %     MEM USAGE / LIMIT     MEM %     NET I/O        BLOCK I/O    PIDS
2330728e0b6e   sleepy_johnson   0.00%     15.47MiB / 3.832GiB   0.39%     11MB / 110kB   0B / 121MB   2
6fbae7fcc895   jinliu-c1        100.35%   519.9MiB / 3.832GiB   13.25%    726B / 0B      0B / 0B      7

root@castillo:/opt/cicd# top
top - 17:08:28 up 10 days,  2:41,  8 users,  load average: 0.67, 1.56, 1.21
Tasks: 140 total,   5 running, 135 sleeping,   0 stopped,   0 zombie
%Cpu0  :  0.3 us,  0.3 sy,  0.0 ni, 99.0 id,  0.3 wa,  0.0 hi,  0.0 si,  0.0 st
%Cpu1  : 85.4 us, 14.6 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
MiB Mem :   3924.0 total,   1197.7 free,    587.1 used,   2139.2 buff/cache
MiB Swap:   3925.0 total,   3924.7 free,      0.3 used.   3044.8 avail Mem 

    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND                                                                                                                                                          
  32574 root      20   0    6908   2496    672 R  25.0   0.1   0:01.65 stress-ng-cpu                                                                                                                                                    
  32576 root      20   0    6908   2496    672 R  25.0   0.1   0:01.66 stress-ng-cpu                                                                                                                                                    
  32578 root      20   0  268408 150288    540 R  25.0   3.7   0:01.65 stress-ng-vm                                                                                                                                                     
  32579 root      20   0  268408 152136    540 R  25.0   3.8   0:01.65 stress-ng-vm  
```

### 对比两个容器cpu限制情况

```bash
#C1
root@castillo:~# docker run -it --rm --name jinliu-c1 --cpus 1  --cpu-shares 800 lorel/docker-stress-ng --cpu 1 --vm 2
stress-ng: info: [1] defaulting to a 86400 second run per stressor
stress-ng: info: [1] dispatching hogs: 1 cpu, 2 vm

root@castillo:~# docker stats
CONTAINER ID   NAME             CPU %     MEM USAGE / LIMIT     MEM %     NET I/O        BLOCK I/O    PIDS
2330728e0b6e   sleepy_johnson   0.00%     15.47MiB / 3.832GiB   0.39%     11MB / 110kB   0B / 121MB   2
5640562a51c1   jinliu-c1        97.83%    517.8MiB / 3.832GiB   13.20%    796B / 0B      0B / 0B      6

root@castillo:~# top
top - 17:13:30 up 10 days,  2:46, 10 users,  load average: 1.23, 1.55, 1.34
Tasks: 147 total,   5 running, 142 sleeping,   0 stopped,   0 zombie
%Cpu(s): 51.0 us,  0.5 sy,  0.0 ni, 48.5 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
MiB Mem :   3924.0 total,    997.4 free,    787.3 used,   2139.3 buff/cache
MiB Swap:   3925.0 total,   3924.7 free,      0.3 used.   2844.5 avail Mem 

    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND                                                                                                                                                          
  32745 root      20   0  268408 262544    596 R  49.5   6.5   0:37.75 stress-ng-vm                                                                                                                                                     
  32746 root      20   0  268408 262544    596 R  25.2   6.5   0:18.99 stress-ng-vm                                                                                                                                                     
  32742 root      20   0    6908   2432    604 R  24.9   0.1   0:19.01 stress-ng-cpu                                                                                                                                                    
   2596 root      20   0 1356280  58640  35812 S   0.3   1.5   1:34.86 containerd                                                                                                                                                       
  10621 castillo  20   0   17300   8072   5660 S   0.3   0.2   0:01.02 sshd  
  
#C2
root@castillo:~# docker run -it --rm --name jinliu-c2 --cpus 1  --cpu-shares 400 lorel/docker-stress-ng --cpu 1 --vm 2
stress-ng: info: [1] defaulting to a 86400 second run per stressor
stress-ng: info: [1] dispatching hogs: 1 cpu, 2 vm

root@castillo:~# docker stats
2330728e0b6e   sleepy_johnson   0.00%     15.47MiB / 3.832GiB   0.39%     11MB / 110kB   0B / 121MB   2
5640562a51c1   jinliu-c1        100.22%   517.8MiB / 3.832GiB   13.20%    866B / 0B      0B / 0B      6
03dd3139eb2d   jinliu-c2        98.85%    314.3MiB / 3.832GiB   8.01%     656B / 0B      0B / 0B      6

root@castillo:~# top1
top - 17:15:15 up 10 days,  2:47, 10 users,  load average: 3.74, 2.09, 1.54
Tasks: 153 total,   7 running, 146 sleeping,   0 stopped,   0 zombie
%Cpu(s): 99.0 us,  0.7 sy,  0.0 ni,  0.3 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
MiB Mem :   3924.0 total,    466.8 free,   1315.5 used,   2141.7 buff/cache
MiB Swap:   3925.0 total,   3924.7 free,      0.3 used.   2314.1 avail Mem 

    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND                                                                                                                                                          
  32831 root      20   0  268408 262528    580 R  39.3   6.5   0:15.76 stress-ng-vm                                                                                                                                                     
  32742 root      20   0    6908   2432    604 R  37.7   0.1   0:50.53 stress-ng-cpu                                                                                                                                                    
  32746 root      20   0  268408 262544    596 R  32.3   6.5   0:48.67 stress-ng-vm                                                                                                                                                     
  32745 root      20   0  268408 262544    596 R  30.0   6.5   1:21.84 stress-ng-vm                                                                                                                                                     
  32828 root      20   0    6908   2456    628 R  29.3   0.1   0:12.53 stress-ng-cpu                                                                                                                                                    
  32832 root      20   0  268408 262528    580 R  29.0   6.5   0:12.90 stress-ng-vm                                                                                                                                                     
   4154 root      20   0 1595372  84380  50980 S   0.3   2.1   1:29.97 dockerd                                                                                                                                                          
  31232 root      20   0  712656  11152   8296 S   0.3   0.3   0:03.21 containerd-shim  
```

### systemd验证

```bash
root@castillo:~# docker ps
CONTAINER ID   IMAGE                                 COMMAND                  CREATED          STATUS          PORTS                                        NAMES
5565cf04c53b   lorel/docker-stress-ng                "/usr/bin/stress-ng …"   38 seconds ago   Up 36 seconds                                                jinliu-c1
2330728e0b6e   harbor.jinliu.net/myserver/nginx:v1   "nginx -g 'daemon of…"   2 hours ago      Up 2 hours      0.0.0.0:80->80/tcp, :::80->80/tcp, 443/tcp   sleepy_johnson
root@castillo:~# ps -ef |grep nginx
root       31251   31232  0 15:31 pts/0    00:00:00 nginx: master process nginx -g daemon off;
nobody     31505   31251  0 15:39 pts/0    00:00:00 nginx: worker process
root       33005   32653  0 17:21 pts/8    00:00:00 grep --color=auto nginx
root@castillo:~# cat /proc/31251/cpuset 
/system.slice/docker-2330728e0b6e9110151f74b714365945522e66e8c03d723f875e09c112748d6c.scope
root@castillo:~# cat /sys/fs/cgroup/system.slice/docker-2330728e0b6e9110151f74b714365945522e66e8c03d723f875e09c112748d6c.scope/cpu.max
max 100000
root@castillo:~# cat /sys/fs/cgroup/system.slice/docker-2330728e0b6e9110151f74b714365945522e66e8c03d723f875e09c112748d6c.scope/memory.max 
max
root@castillo:~#
```

## 部署http协议的harbor镜像仓库

### 优点

![5](../002/5.png)

### 安装harbor

```bash
#修改域名
root@castillo:/apps# ls -l
total 739540
-rw-rw-r-- 1 castillo castillo 757278514 Oct 30 14:48 harbor-offline-installer-v2.6.1.tgz
drwxr-xr-x 2 root     root          4096 Oct 30 14:30 nginx
root@castillo:/apps# tar -zxf harbor-offline-installer-v2.6.1.tgz 
root@castillo:/apps# cd harbor
root@castillo:/apps/harbor# vim harbor.yml
root@castillo:/apps/harbor# grep -A 10 "jinliu" harbor.yml
hostname: harbor.jinliu.net

# http related config
http:
  # port for http, default is 80. If https enabled, this port will redirect to https port
  port: 80

# https related config
https:
  # https port for harbor, default is 443
  port: 443
root@castillo:/apps/harbor#

#配置本地域名解析
root@castillo:/apps/harbor# cat /etc/hosts
127.0.0.1 localhost
127.0.1.1 castillo

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters

192.168.31.113 harbor.jinliu.net
root@castillo:/apps/harbor# 

#配置域名信任
root@castillo:/apps/harbor# cat /etc/docker/daemon.json
{
  "registry-mirrors": ["https://r1yv1i78.mirror.aliyuncs.com"],
  "insecure-registries": ["harbor.jinliu.net","192.168.31.113"]
}
root@castillo:/apps/harbor# 

#安装
root@castillo:/apps/harbor# bash install.sh 

#登录
root@castillo:/apps/harbor# docker login harbor.jinliu.net
Username: admin
Password: 
WARNING! Your password will be stored unencrypted in /root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
root@castillo:/apps/harbor# 
```

### 推进镜像

```bash
root@castillo:/apps/harbor# docker tag lorel/docker-stress-ng:latest harbor.jinliu.net/myserver/docker-stress-ng:latest
root@castillo:/apps/harbor# docker push  harbor.jinliu.net/myserver/docker-stress-ng:latest
The push refers to repository [harbor.jinliu.net/myserver/docker-stress-ng]
5f70bf18a086: Pushed 
ea580b0285fe: Pushed 
6102f0d2ad33: Pushed 
latest: digest: sha256:5768a5d8e196be8c8fabbda04d937aabe1407f397b2f12e1fea2573e4b9d9bef size: 1563
root@castillo:/apps/harbor# 
```

![6](../002/6.png)

## 基于docker-compose实现对nginx+tomcat web服务的单机编排

### docker-compose介绍

```bash
#compose、machine 和 swarm 是docker 原生提供的三大编排工具。简称docker三剑客。
#Docker Compose能够在 Docker 节点上，以单引擎模式(Single-Engine Mode)进行多容器应用的部 署和管理。多数的现代应用通过多个更小的微服务互相协同来组成一个完整可用的应用。
#部署和管理繁多的服务是困难的。而这正是 Docker Compose 要解决的问题。Docker Compose 并不 是通过脚本和各种冗长的 docker 命令来将应用组件组织起来，而是通过一个声明式的配置文件描述整 个应用，从而使用一条命令完成部署。应用部署成功后，还可以通过一系列简单的命令实现对其完整声 明周期的管理。甚至，配置文件还可以置于版本控制系统中进行存储和管理。
```

#### yml文件

```bash
#Docker Compose 的 YAML 文件包含 4 个一级 key:version、services、networks、volumes

--#version 是必须指定的，而且总是位于文件的第一行。它定义了 Compose 文件格式(主要是 API)的版本。注意，version 并非定义 Docker Compose 或 Docker 引擎的版本号。

--#services 用于定义不同的应用服务。例如定义了两个服务:一个名为 mysql-r数据库服务以及一个名为eureka-r的微服。Docker Compose 会将每个服务部署在各自的容器中。

--#networks 用于指引 Docker 创建新的网络。默认情况下，Docker Compose 会创建 bridge 网络。 这是一种单主机网络，只能够实现同一主机上容器的连接。当然，也可以使用 driver 属性来指定不 同的网络类型。

--#volumes 用于指引 Docker 来创建新的卷。
```

```yaml
#示例
version: '3.6' #版本号，https://docs.docker.com/compose/compose-file/compose-versioning/
services: #定义服务
  nginx-server: #当前容器的服务名
    image: nginx:1.22.0-alpine #镜像名称
    container_name: nginx-web1 #r容器名称
    expose: #声明端口映射
    - 80
    - 443
    ports: #定义端口映射
    - "80:80"
    - "443:443"
```

#### 命令

```sh
-f, --file FILE              #指定compsoe 文件，默认为docker-compose.yml
-p, --project-name NAME      #指定功能名称，默认为当前所在的目录名
--profile NAME               #指定一个服务名称，只执行docker-compose.yml中某些profile 匹配名称的容器

# docker-compose --profile frontend up -d
-c, --context NAME           #指定Dockerfile的文件路径,也可以是链接到git仓库的url
--verbose                    #显示更多输出信息
--log-level LEVEL            #定义日志级别，DEBUG, INFO, WARNING, ERROR, CRITICAL
--ansi (never|always|auto)   #定义什么时候显示ANSI控制字符
--no-ansi                    #不显示ANSI字符，已废弃
-v, --version                #显示docker-compose的版本信息
-H, --host HOST              #连接到docker主机，默认为本机
--tls                        #启用tls
--tlscacert                  #tls ca私钥
--tlscert                    #tls ca公钥
--tlskey                     #服务私钥
--tlsverify                  #服务公钥
--skip-hostname-check        #不对证书校验(跳过检查证书签发的主机名)
--env-file PATH              #指定文件向容器添加环境变量
```

```bash
#build #构建或重新构建服务、在修改Dockerfile后,可以通过docker-compose build重新构建镜像并重建服务
#bundle #从当前docker compose文件生成一个以当前目录为名称的从Compose文件生成一个分布式应用程序捆绑包(DAB)、已废弃
--config -q #验证docker-compose.yml文件，没有错误不输出任何信息
#create #创建服务,但是容器不启动
--down #停止并删除资源，默认会删除容器和网络
#events #从容器接收实时事件，可以指定json日志格式，如
# docker-compose events --json
#exec #基于service进入指定容器执行命令
# docker-compose ps --services
# docker exec -it nginx-web1 sh
--help #显示帮助细信息
--images #列出本地镜像
--kill #强制终止运行中的容器
# docker-compose kill -s SIGKILL nginx-server #SIG是信号名的通用前缀，KILL是指让一个进程立即终止的动作,合并起来SIGKILL就是发送给一个进程使进程立即终止的信号。
--logs #基于service查看容器的日志
# docker-compose logs --tail="10" -f nginx-server
#pause #暂停服务
# docker-compose ps --service
# docker-compose pause nginx-server
#命令选项，需要在docker-compose.yml文件目录执行，带#的不常用
#port #基于service查看容器的端口绑定信息
# docker-compose port --protocol=tcp nginx-server 80
--ps #列出容器信息
--pull #拉取镜像
#push #上传镜像
#restart #重启服务
--rm #删除已经停止的服务
#run #一次性运行容器,等于docker run --rm
--scale #设置指定服务运行的容器个数
# docker-compose scale nginx-server=2 #动态伸缩每个service的副本数,不能指定容器名和端口映射
--start #启动服务
# docker-compose start nginx-server
--stop #停止服务
# docker-compose stop nginx-server
--top #显示容器运行状态
# docker-compose top
--unpause #取消暂定状态中的server
# docker-compose unpause nginx-server
--up #创建并启动容器，通常配合-d参数在后台运行容器
# docker-compose up -d
--version #显示docker-compose版本信息
```



- **ps**：列出所有运行容器

```sh
docker-compose ps
```

- **logs**：查看服务日志输出

```sh
docker-compose logs
```

- **port**：打印绑定的公共端口，下面命令可以输出 eureka 服务 8761 端口所绑定的公共端口

```sh
docker-compose port eureka 8761
```

- **build**：构建或者重新构建服务

```sh
docker-compose build
```

- **start**：启动指定服务已存在的容器

```sh
docker-compose start eureka
```

- **stop**：停止已运行的服务的容器

```sh
docker-compose stop eureka
```

- **rm**：删除指定服务的容器

```sh
docker-compose rm eureka
```

- **up**：构建、启动容器

```sh
docker-compose up
```

- **kill**：通过发送 SIGKILL 信号来停止指定服务的容器

```sh
docker-compose kill eureka
```

- **pull**：下载服务镜像
- **scale**：设置指定服务运气容器的个数，以 service=num 形式指定

```sh
docker-compose scale user=3 movie=3
```

- **run**：在一个服务上执行一个命令

```sh
docker-compose run web bash
```

### nginx+tomcat web服务的单机编排

#### 准备镜像

```sh
[root@k8s-c-jl-01 ~]# docker images
REPOSITORY                          TAG       IMAGE ID       CREATED         SIZE
harbor.jinliu.net/myserver/tomcat   v1        fb5657adc892   10 months ago   680MB
harbor.jinliu.net/myserver/nginx    1.20.1    c8d03f6b8b91   12 months ago   133MB
[root@k8s-c-jl-01 ~]# 
```

#### 准备文件以及挂载目录

```bash
[root@k8s-c-jl-01 docker-compose]# tree .
.
├── docker-compose.yml
└── nginx
    ├── nginx.conf
    └── www
        ├── images
        │   └── 1.jpg
        └── index.html

3 directories, 4 files
[root@k8s-c-jl-01 docker-compose]#
```

#### docker-compose.yml

```sh
##version版本设置很重要！！！！！需要和docker-compose版本一致，否则docker-compose无法解析。例如docker-compose版本为1.18.0，那么docker-compose。yml中version需要设置成‘2’。
[root@k8s-c-jl-01 docker-compose]# vim docker-compose.yml
version: '2'
services:
  tomcat01:
    container_name: tomcat01
    image: harbor.jinliu.net/myserver/tomcat:v1
    restart: always
    ports:
      - 8080
  tomcat02:
    container_name: tomcat02
    image: harbor.jinliu.net/myserver/tomcat:v1
    restart: always
    ports:
      - 8080
  nginx:
    container_name: www-nginx
    image: harbor.jinliu.net/myserver/nginx:1.20.1
    restart: always
    ports:
        - 80:80
    volumes:
        - /opt/docker-compose/nginx/www/:/usr/share/nginx/html/
        - /opt/docker-compose/nginx/nginx.conf:/etc/nginx/nginx.conf
    links:
        - tomcat01
        - tomcat02
```

#### nginx.conf

```sh
[root@k8s-c-jl-01 nginx]# cat nginx.conf | grep -v "#"  |grep -v  ^$ 
worker_processes  2;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
upstream tomcat {
  server tomcat01:8080;
  server tomcat02:8080;
}
    server {
        listen       80;
        server_name  localhost;
        location / {
            root   html;
            index  index.html index.htm;
        }
        location /myapp {
           proxy_pass http://tomcat;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
[root@k8s-c-jl-01 nginx]#
```

#### 启动部署

```bash
[root@k8s-c-jl-01 docker-compose]# docker-compose up -d 
Creating tomcat02 ... done
Creating www-nginx ... done
Creating tomcat02 ... 
Creating www-nginx ... 
[root@k8s-c-jl-01 docker-compose]# docker-compose ps
  Name                 Command               State                     Ports                   
-----------------------------------------------------------------------------------------------
tomcat01    catalina.sh run                  Up      0.0.0.0:49153->8080/tcp,:::49153->8080/tcp
tomcat02    catalina.sh run                  Up      0.0.0.0:49154->8080/tcp,:::49154->8080/tcp
www-nginx   /docker-entrypoint.sh ngin ...   Up      0.0.0.0:80->80/tcp,:::80->80/tcp          
```

#### 测试页面

```sh
#由于没有资源所有访问404，但实际部署成功。
[root@k8s-c-jl-01 docker-compose]# ip -4 a |grep "eth0"
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    inet 192.168.31.127/24 brd 192.168.31.255 scope global noprefixroute eth0
```

![7](../002/7.png)

## 掌握containerd的安装

### 简介

```sh
#Containerd在v1.0及以前版本(目前最新v1.6.8)将dockershim和docker daemon替换为cri-containerd+containerd，而在1.1版本时直接将cri-containerd内置在Containerd中，简化为一个CRI插件，用于实现和kubelet的对接。
#Containerd内置的CRI(container runtime interface)插件实现了Kubelet CRI接口中的Image Service和Runtime Service，通过内部接口管理容器和镜像，并通过CNI(container network interface)插件给Pod配置网络。
```

![8](../002/8.png)

![9](../002/9.png)



### centos安装containerd

```sh
[root@k8s-c-jl-01 docker-compose]# yum list containerd.io --showduplicates
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
 * base: mirrors.aliyun.com
 * epel: ftp.riken.jp
 * extras: mirrors.aliyun.com
 * updates: mirrors.aliyun.com
Installed Packages
containerd.io.x86_64                                                                                        1.6.9-3.1.el7                                                                                               @docker-ce-stable
Available Packages
containerd.io.x86_64                                                                                        1.2.0-1.2.beta.2.el7                                                                                        docker-ce-stable 
containerd.io.x86_64                                                                                        1.2.0-2.0.rc.0.1.el7                                                                                        docker-ce-stable 
containerd.io.x86_64                                                                                        1.2.0-2.2.rc.2.1.el7                                                                                        docker-ce-stable 
containerd.io.x86_64                                                                                        1.2.0-3.el7                                                                                                 docker-ce-stable 
containerd.io.x86_64                                                                                        1.2.2-3.el7                                                                                                 docker-ce-stable 
containerd.io.x86_64                                                                                        1.2.2-3.3.el7                                                                                               docker-ce-stable 
containerd.io.x86_64                                                                                        1.2.4-3.1.el7                                                                                               docker-ce-stable 
containerd.io.x86_64                                                                                        1.2.5-3.1.el7                                                                                               docker-ce-stable 
containerd.io.x86_64                                                                                        1.2.6-3.3.el7                                                                                               docker-ce-stable 
containerd.io.x86_64                                                                                        1.2.10-3.2.el7                                                                                              docker-ce-stable 
containerd.io.x86_64                                                                                        1.2.13-3.1.el7                                                                                              docker-ce-stable 
containerd.io.x86_64                                                                                        1.2.13-3.2.el7                                                                                              docker-ce-stable 
containerd.io.x86_64                                                                                        1.3.7-3.1.el7                                                                                               docker-ce-stable 
containerd.io.x86_64                                                                                        1.3.9-3.1.el7                                                                                               docker-ce-stable 
containerd.io.x86_64                                                                                        1.4.3-3.1.el7                                                                                               docker-ce-stable 
containerd.io.x86_64                                                                                        1.4.3-3.2.el7                                                                                               docker-ce-stable 
containerd.io.x86_64                                                                                        1.4.4-3.1.el7                                                                                               docker-ce-stable 
containerd.io.x86_64                                                                                        1.4.6-3.1.el7                                                                                               docker-ce-stable 
containerd.io.x86_64                                                                                        1.4.8-3.1.el7                                                                                               docker-ce-stable 
containerd.io.x86_64                                                                                        1.4.9-3.1.el7                                                                                               docker-ce-stable 
containerd.io.x86_64                                                                                        1.4.10-3.1.el7                                                                                              docker-ce-stable 
containerd.io.x86_64                                                                                        1.4.11-3.1.el7                                                                                              docker-ce-stable 
containerd.io.x86_64                                                                                        1.4.12-3.1.el7                                                                                              docker-ce-stable 
containerd.io.x86_64                                                                                        1.4.13-3.1.el7                                                                                              docker-ce-stable 
containerd.io.x86_64                                                                                        1.5.10-3.1.el7                                                                                              docker-ce-stable 
containerd.io.x86_64                                                                                        1.5.11-3.1.el7                                                                                              docker-ce-stable 
containerd.io.x86_64                                                                                        1.6.4-3.1.el7                                                                                               docker-ce-stable 
containerd.io.x86_64                                                                                        1.6.6-3.1.el7                                                                                               docker-ce-stable 
containerd.io.x86_64                                                                                        1.6.7-3.1.el7                                                                                               docker-ce-stable 
containerd.io.x86_64                                                                                        1.6.8-3.1.el7                                                                                               docker-ce-stable 
containerd.io.x86_64                                                                                        1.6.9-3.1.el7                                                                                               docker-ce-stable 
[root@k8s-c-jl-01 docker-compose]# yum install containerd.io-1.6.9 -y
```

### 修改默认配置

```bash
[root@k8s-c-jl-01 docker-compose]# containerd config default > /etc/containerd/config.toml
[root@k8s-c-jl-01 docker-compose]# cat /etc/containerd/config.toml |grep -E -n 'sandbox_|docker\.io|r1yv1i78'
61:    sandbox_image = "registry.aliyuncs.com/google_containers/pause:3.7"
154:      [plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"]
155:      endpoint = ["https://r1yv1i78.mirror.aliyuncs.com"]
[root@k8s-c-jl-01 docker-compose]#
```

### 启动

```bash
[root@k8s-c-jl-01 docker-compose]# systemctl enable containerd --now
Created symlink from /etc/systemd/system/multi-user.target.wants/containerd.service to /usr/lib/systemd/system/containerd.service.
[root@k8s-c-jl-01 docker-compose]# 
```

### 更新runc

```sh
[root@k8s-c-jl-01 ~]# wget https://github.com/opencontainers/runc/releases/download/v1.1.4/runc.amd64
[root@k8s-c-jl-01 ~]# > yes |cp -rf runc.amd64 /usr/bin/runc
cp: overwrite ‘/usr/bin/runc’? [root@k8s-c-jl-01 ~]# 
[root@k8s-c-jl-01 ~]# chmod a+x /usr/bin/runc
[root@k8s-c-jl-01 ~]# runc -v
runc version 1.1.4
commit: v1.1.4-0-g5fd4c4d
spec: 1.0.2-dev
go: go1.18.7
libseccomp: 2.3.1
[root@k8s-c-jl-01 ~]#
```

### 客户端使用

```sh
#containerd相比docker多了一个命名空间的逻辑概念，ctr命令默认是在default命名空间里，当使用crictl命令的时候，都是在k8s.io这个命名空间里的，所以不指定namespace会发现看到的镜像、容器等内容不一样。
```



#### ctr

```sh
#拉取镜像
[root@k8s-c-jl-01 ~]# ctr images pull docker.io/library/nginx:1.20.2
docker.io/library/nginx:1.20.2:                                                   resolved       |++++++++++++++++++++++++++++++++++++++| 
index-sha256:38f8c1d9613f3f42e7969c3b1dd5c3277e635d4576713e6453c6193e66270a6d:    done           |++++++++++++++++++++++++++++++++++++++| 
manifest-sha256:a76df3b4f1478766631c794de7ff466aca466f995fd5bb216bb9643a3dd2a6bb: done           |++++++++++++++++++++++++++++++++++++++| 
layer-sha256:e8750203e98541223fb970b2b04058aae5ca11833a93b9f3df26bd835f66d223:    done           |++++++++++++++++++++++++++++++++++++++| 
layer-sha256:50836501937ff210a4ee8eedcb17b49b3b7627c5b7104397b2a6198c569d9231:    done           |++++++++++++++++++++++++++++++++++++++| 
config-sha256:0584b370e957bf9d09e10f424859a02ab0fda255103f75b3f8c7d410a4e96ed5:   done           |++++++++++++++++++++++++++++++++++++++| 
layer-sha256:d838e0361e8efc1fb3ec2b7aed16ba935ee9b62b6631c304256b0326c048a330:    done           |++++++++++++++++++++++++++++++++++++++| 
layer-sha256:214ca5fb90323fe769c63a12af092f2572bf1c6b300263e09883909fc865d260:    done           |++++++++++++++++++++++++++++++++++++++| 
layer-sha256:fcc7a415e354b2e1a2fcf80005278d0439a2f87556e683bb98891414339f9bee:    done           |++++++++++++++++++++++++++++++++++++++| 
layer-sha256:dc73b4533047ea21262e7d35b3b2598e3d2c00b6d63426f47698fe2adac5b1d6:    done           |++++++++++++++++++++++++++++++++++++++| 
elapsed: 13.4s                                                                    total:  24.2 M (1.8 MiB/s)                                       
unpacking linux/amd64 sha256:38f8c1d9613f3f42e7969c3b1dd5c3277e635d4576713e6453c6193e66270a6d...
done: 3.164961912s
[root@k8s-c-jl-01 ~]# ctr  images ls
REF                            TYPE                                                      DIGEST                                                                  SIZE     PLATFORMS                                                                                               LABELS 
docker.io/library/nginx:1.20.2 application/vnd.docker.distribution.manifest.list.v2+json sha256:38f8c1d9613f3f42e7969c3b1dd5c3277e635d4576713e6453c6193e66270a6d 54.1 MiB linux/386,linux/amd64,linux/arm/v5,linux/arm/v7,linux/arm64/v8,linux/mips64le,linux/ppc64le,linux/s390x -      
[root@k8s-c-jl-01 ~]#

#运行容器并使用宿主机网络
[root@k8s-c-jl-01 docker-compose]# ctr run -t --net-host docker.io/library/nginx:1.20.2 test-container
/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration
/docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d/
/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh
10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf
10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 in /etc/nginx/conf.d/default.conf
/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh
/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh
/docker-entrypoint.sh: Configuration complete; ready for start up
2022/11/05 06:58:38 [notice] 1#1: using the "epoll" event method
2022/11/05 06:58:38 [notice] 1#1: nginx/1.20.2
2022/11/05 06:58:38 [notice] 1#1: built by gcc 10.2.1 20210110 (Debian 10.2.1-6) 
2022/11/05 06:58:38 [notice] 1#1: OS: Linux 3.10.0-957.el7.x86_64
2022/11/05 06:58:38 [notice] 1#1: getrlimit(RLIMIT_NOFILE): 1024:1024
2022/11/05 06:58:38 [notice] 1#1: start worker processes
2022/11/05 06:58:38 [notice] 1#1: start worker process 31
2022/11/05 06:58:38 [notice] 1#1: start worker process 32
```

#### nerdctl

```SH
#一个兼容docker的containerd的客户端,https://github.com/containerd/nerdctl
```

```sh
[root@k8s-c-jl-01 ~]# wget https://github.com/containerd/nerdctl/releases/download/v0.23.0/nerdctl-0.23.0-linux-amd64.tar.gz
[root@k8s-c-jl-01 ~]# tar xvf nerdctl-0.23.0-linux-amd64.tar.gz -C /usr/bin/
nerdctl
containerd-rootless-setuptool.sh
containerd-rootless.sh
[root@k8s-c-jl-01 ~]# 
```

#### cni

```sh
[root@k8s-c-jl-01 ~]# wget https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz
[root@k8s-c-jl-01 ~]# mkdir /opt/cni/bin -pv
mkdir: created directory ‘/opt/cni’
mkdir: created directory ‘/opt/cni/bin’
[root@k8s-c-jl-01 ~]# tar xvf cni-plugins-linux-amd64-v1.1.1.tgz -C /opt/cni/bin/
./
./macvlan
./static
./vlan
./portmap
./host-local
./vrf
./bridge
./tuning
./firewall
./host-device
./sbr
./loopback
./dhcp
./ptp
./ipvlan
./bandwidth
[root@k8s-c-jl-01 ~]#
```

#### 创建容器并指定端口

```sh
#nginx
[root@k8s-c-jl-01 ~]# nerdctl run -d -p 81:80 --name=nginx-web1 --restart=always nginx:1.20.2
0ca0d45033844bf05df524ed5f4fdd214e41085f75e828451f4d81410f2c0663
[root@k8s-c-jl-01 ~]# nerdctl ps
CONTAINER ID    IMAGE                             COMMAND                   CREATED          STATUS    PORTS                 NAMES
0ca0d4503384    docker.io/library/nginx:1.20.2    "/docker-entrypoint.…"    9 seconds ago    Up        0.0.0.0:81->80/tcp    nginx-web1

#tomcat
[root@k8s-c-jl-01 ~]# nerdctl run -d -p 8080:8080 --name=tomcat-web --restart=always tomcat:7.0.88-alpine
docker.io/library/tomcat:7.0.88-alpine:                                           resolved       |++++++++++++++++++++++++++++++++++++++| 
index-sha256:fbea9924c4e324b2eee05fbb4317d0fd768f15387f8c77a5d6ee4c4cbdc5a0bc:    done           |++++++++++++++++++++++++++++++++++++++| 
manifest-sha256:3a1bfd26628b05080841b61ce33a581b137243ef77967a86a7e0ab06148d6a8f: done           |++++++++++++++++++++++++++++++++++++++| 
config-sha256:2c15647bb9a382cf774b7906e6489e2f5491ac6e66593c6a66d6c0d61989c8f1:   done           |++++++++++++++++++++++++++++++++++++++| 
layer-sha256:44e6d293805b58dc5838472788c76c025026ac2c14044d598127d06066a25d5f:    done           |++++++++++++++++++++++++++++++++++++++| 
layer-sha256:cbee32cff593b645ca1694f052ad0545fe5a7bfd1fdc9087624013627ddb041c:    done           |++++++++++++++++++++++++++++++++++++++| 
layer-sha256:6334d5b42b354493d40f92ab8d15c307273f5ff11f70421d1bddacc91416adb8:    done           |++++++++++++++++++++++++++++++++++++++| 
layer-sha256:911c6d0c7995e5d9763c1864d54fb6deccda04a55d7955123a8e22dd9d44c497:    done           |++++++++++++++++++++++++++++++++++++++| 
layer-sha256:3ae691a546b360850dc64c3f25ebab76406ea37a6abaf5a00109627dcfea839f:    done           |++++++++++++++++++++++++++++++++++++++| 
layer-sha256:4001add52a901363833fa030b1451162d380a5423906a45f64e090a5ee9efb74:    done           |++++++++++++++++++++++++++++++++++++++| 
elapsed: 18.1s                                                                    total:  73.8 M (4.1 MiB/s)                                       
5f22d4ea208ecb3ad072657f54b42355113308a6f983f1eb8e5a08f7e7e55e27
[root@k8s-c-jl-01 ~]# nerdctl ps
CONTAINER ID    IMAGE                                     COMMAND                   CREATED           STATUS    PORTS                     NAMES
0ca0d4503384    docker.io/library/nginx:1.20.2            "/docker-entrypoint.…"    7 minutes ago     Up        0.0.0.0:81->80/tcp        nginx-web1
5f22d4ea208e    docker.io/library/tomcat:7.0.88-alpine    "catalina.sh run"         31 seconds ago    Up        0.0.0.0:8080->8080/tcp    tomcat-web
[root@k8s-c-jl-01 ~]# 
```

#### 验证

![10](../002/10.png)

![11](../002/11.png)



